---
title: "QA for ØKOKYST 2019 report (January 2020)"
author: "DHJ"
date: "13 1 2020"
output: html_document
---



**Section 2-7 = Skagerrak, done by André**  
See  
- mail from Andre 10.1.2020 (pluss 8.1)
- Statistikk (Perc90 etc) beregnet i 
  `K:\Avdeling\214-Oseanografi\DATABASER\OKOKYST_2017\AqM_download_2019`,   
  filer: AqM_2019_Skag_des2019.xlsx + (for VT4) AqM_2019_Ferrybox_des2019.xlsx
- Perc90 er så tatt over i 
  `K:\Prosjekter\Sjøvann\KYSTOVERVÅKING ØKOKYST\KYSTOVERVÅKING ØKOKYST 2017-2020\ØKOKYST DP Skagerrak O-17089_19089\Årsrapport2019\Vannmassene\NIVAklass`
  der selve klassifiseringen er gjort i Excel-ark  
- Analyserapporter finnes i (eksempel):
K:\Prosjekter\Sjøvann\KYSTOVERVÅKING ØKOKYST\KYSTOVERVÅKING ØKOKYST 2017-2020\ØKOKYST DP Skagerrak O-17089_19089\Hydrografi\Analyserapport_2017

**Section 11-15 = Norskehavet Sør I, done by Caroline**   
-  Checked input to this file:  
`K:\Prosjekter\Sjøvann\KYSTOVERVÅKING ØKOKYST\KYSTOVERVÅKING ØKOKYST 2017-2020\ØKOKYST DP Norskehavet Sør I O-17091_18091_19091_200091\Rapport 2019-data\klassification`  

   
**Veileder:**  
- `Documents\artikler\veiledere etc\02_2013_klassifiserings-veileder_.pdf`  
- Chlorophyll: page 91.   
"I SørNorge (til Stadt) anbefales det at innsamlingen starter i februar og avsluttes ved utgangen av oktober."   
"Nord for Stadt anbefales det at innsamlingsperioden strekker seg fra mars til og med september."   
90% percentiles should be used   
  
- Also see calculation example on on page 187-189, and the comment on page 189:  
"Det gjøres oppmerksom på at dataprogrammene som beregner 90-persentil, gjerne benytter ulike metoder". We use the Excel method PERCENTILE.EXC, corresponding to type 6 quantiles in R  
  
- Nutrients: page 102   
Vinter er november til og med februar   
Sommer er juni til og med august  

  
## 1. Libraries
```{r}

library(dplyr)
library(purrr)
library(ggplot2)
library(lubridate)
library(readxl)
library(tidyr)
library(RColorBrewer)

# library(niRvana)

source("12_QA_2019_from_excel_functions.R")
source("13_QA_CTD_2019_functions.R")          # used in section 15  


# RColorBrewer::display.brewer.all()
```


## 2. Read Skagerrak file   
Used by André  
```{r}

fn <- "K:/Avdeling/214-Oseanografi/DATABASER/OKOKYST_2017/AqM_download_2019/AqM_2019_Skag_des2019.xlsx"
df_chl <- read_excel(fn, sheet = "klfa")


```

## 3. ChlA, check quantiles  
  
Note: see part 5 for same check, based on raw data  
  
Using type 6 quantiles, which correspond to PERCENTILE.EXC in Excel (see https://www.r-bloggers.com/the-problem-with-percentiles-2/)  
  
- Compare with 90% percentiles in the same Excel work sheet ("klfa" work sheet)
- All quantiles are OK  
```{r}
# df_chl$StationCode %>% unique() %>% dput()
# order_as_excel <- c("VT10", "VT67", "VT3", "VT65", "VT66", "VT2", "VT68")

order_as_excel <- unique(df_chl$StationCode)
  
df_quantiles <- df_chl %>%
  mutate(StationCode = factor(StationCode, levels = order_as_excel)) %>%  # same order as in Excel file
  group_by(StationCode) %>%
  summarise_at(c("KlfA 0m", "KlfA 5m", "KlfA 10m", "KlfA max 0-10"), 
               quantile, probs = 0.9, na.rm = TRUE, type = 6)    # type 6 = PERCENTILE.EXC() in Excel

df_quantiles

```

### Plot quantiles I   
A single ggplot  
```{r}
# print(ggplot(df, aes(x = `KlfA max 0-10`)) + geom_histogram())

ggplot(df_chl, aes(x = `KlfA max 0-10`)) + 
  geom_histogram() +
  geom_vline(data = df_quantiles, aes(xintercept = `KlfA max 0-10`), color = "red") +
  facet_wrap("StationCode")

```

### Plot for quantiles II    
Separate plots  
(Tech. note: could have used map2 or pmap instaed of for-else)
```{r}
# print(ggplot(df, aes(x = `KlfA max 0-10`)) + geom_histogram())

df_list <- df_chl %>%
  mutate(StationCode = factor(StationCode, levels = unique(df_chl$StationCode))) %>%  # same order as in Excel file
  split(.$StationCode)


for (name in names(df_list)){
  q90 <- df_quantiles %>%
    filter(StationCode == name) %>%
    pull(`KlfA max 0-10`)
  print(
    ggplot(df_list[[name]], aes(x = `KlfA max 0-10`)) + 
      geom_histogram() +
      geom_vline(xintercept = q90, color = "red") +
      labs(title = name)
  )
  } 

```

## 4. Plot ChlA for each depth    
```{r}

df_chl %>%
  select(StationCode:`KlfA 10m`) %>%
  pivot_longer(cols = `KlfA 0m`:`KlfA 10m`, names_to = "Depth", values_to = "KlfA") %>%
  ggplot(aes(SampleDate, KlfA, color = Depth)) +
  geom_line() +
  geom_hline(data = df_quantiles, aes(yintercept = `KlfA max 0-10`), color = "red") +
  facet_wrap("StationCode")

```


## 5. Checking based on raw data  

### Read raw data  
Pretty big (30 seconds)  
```{r}

fn <- "K:/Avdeling/214-Oseanografi/DATABASER/OKOKYST_2017/AqM_download_2019/AqM_2019_Skag_des2019.xlsx"
# For column names
dat_broad <- AqMexport_read_waterchemistry(fn, reformat_long = FALSE)   # 30 seconds
dat1 <- AqMexport_reformat_long(dat_broad, remove_duplicates = FALSE)
dat2 <- AqMexport_remove_duplicates(dat1)

# Check
dat2 %>%
  filter(Variable %in% "KlfA" & Depth1 %in% c(0,5,10) & year(Time) == 2017 & month(Time) == 2)

```



### ChlA test plot    
```{r}
# table(dat2$Variable)
# table(dat2$StationCode)

df_chl_all <- dat2 %>%
  filter(Variable %in% "KlfA" & Depth1 %in% c(0,5,10) & !is.na(Value)) %>%
  group_by(StationId, StationCode, StationName, Time, Depth1, Depth2, Variable) %>%
  summarise(Value = first(Value[!is.na(Value)]), Flag = first(Flag[!is.na(Value)])) %>%
  arrange(StationCode, Depth1, Time) %>%
  ungroup()

df_chl <- df_chl_all %>%
  filter(Time >= ymd("2017-01-01"))

ggplot(df_chl_all, aes(Time, Value, color = factor(Depth1))) +
  geom_line() +
  geom_point(aes(shape = is.na(Flag)), size = 1) +
  facet_wrap("StationCode")

ggplot(df_chl, aes(Time, Value, color = factor(Depth1))) +
  geom_line() +
  geom_point(aes(shape = is.na(Flag)), size = 1) +
  facet_wrap("StationCode")


```

### ChlA, check quantiles    

**Note that this code is improved in section 14 below**
   
As section 3, only that section 3 is based on the already extracted data in that sheet  
  
NOTE:   
- Excel’s PERCENTILE og PERCENTILE.INC = quantile type 7 in R - THIS IS THE CORRECT ONE FOR MIL.DIR.
- Excel’s PERCENTILE.EXC =quantile type 6
- Also see appendix at the end of '07_NIVAklass.R' in `K:\Prosjekter\Sjøvann\KYSTOVERVÅKING ØKOKYST\KYSTOVERVÅKING ØKOKYST 2017-2020\ØKOKYST DP Norskehavet Sør II O-17090_19090\Årsrapport2018\2018_Årsrapport\Vannmassene\NIVAclass`  
Links:   
- https://stat.ethz.ch/R-manual/R-patched/library/stats/html/quantile.html     
- https://www.r-bloggers.com/the-problem-with-percentiles-2/   
```{r}

order_as_excel <- c("VT10", "VT67", "VT3", "VT65", "VT66", "VT2", "VT68")

df_chl_summ <- df_chl %>%
  filter(month(Time) %in% 2:10 & StationCode %in% order_as_excel) %>%     # Feb - October data
  mutate(StationCode = factor(StationCode, levels = order_as_excel)) %>%  # same order as in Excel file
  select(StationCode, Time, Depth1, Variable, Value) %>%
  pivot_wider(names_from = Depth1, values_from = Value, names_prefix = "Depth") %>%
  mutate(Max = pmax(Depth0, Depth5, Depth10, na.rm = TRUE))
df_chl_summ

df_quantiles2 <- df_chl_summ %>%
  group_by(StationCode) %>%
  summarise_at(c("Depth0", "Depth5", "Depth10", "Max"), 
               quantile, probs = 0.9, na.rm = TRUE, type = 6)

df_quantiles2

  
```

## 6. Nutrients, check sums


### Check occurence of "NO3+NO2-N" vs "NO2-N" and "NO3-N"  
- **Not necessary, mostly for curiosity**
- Until 2007, "NO2-N" and "NO3-N" was measured separately   
- 2009-2015, both approaches were used   
- Since 2017, only "NO3+NO2-N" has been measured  
- 2009-2012, also PON mesured in 30-50% of cases  
```{r}
# table(dat2$Variable)

check <- dat2 %>%
  filter(Variable %in% c("TOTN", "NH4-N", "NO3+NO2-N", "NO2-N", "NO3-N", "PON") & !is.na(Value)) %>%
  select(StationCode, Time, Depth1, Variable, Value) %>%
  pivot_wider(names_from = Variable, values_from = Value)
# Check occurence of "NO3+NO2-N" vs "NO2-N" and "NO3-N"

# Only for curiosity
# table(!is.na(check[,"NO3+NO2-N"]), !is.na(check[,"NO2-N"]))  # never both, a few times none
# table(!is.na(check[,"NO3+NO2-N"]), !is.na(check[,"NO3-N"]))  # never both, a few times none
# table(!is.na(check[,"TOTN"]), !is.na(check[,"NO3-N"]))  # never both, a few times none
# table(!is.na(check[,"PON"]))
# table(!is.na(check[,"PON"]), !is.na(check[,"NO3-N"]))      # never both
# table(!is.na(check[,"PON"]), !is.na(check[,"NO3+NO2-N"]))  # both in 482 cases

#
# Show use of 
#
check %>% 
  group_by(Year = year(Time)) %>% 
  summarize(Perc_sum_NO2NO3 = 100*mean(!is.na(`NO3+NO2-N`)),
            Perc_NO3 = 100*mean(!is.na(`NO3-N`)),
            Perc_PON = 100*mean(!is.na(PON)),
            N = n())

```



### Check occurence of P variables   
- **Not necessary, mostly for curiosity**
- Until 1998, only phosphate      
- Since 2001, also TOTP  
- Particulate: POP 2009-2012, TOTP_P from 2017 onwards
```{r}
# table(dat2$Variable)

check <- dat2 %>%
  filter(Variable %in% c("TOTP", "TOTP_P", "PO4-P", "POP") & !is.na(Value)) %>%
  select(StationCode, Time, Depth1, Variable, Value) %>%
  pivot_wider(names_from = Variable, values_from = Value)
# Check occurence of "NO3+NO2-N" vs "NO2-N" and "NO3-N"

# check %>% filter(!is.na(TOTP))
# check %>% filter(year(Time) >= 2017)

#
# Show use of P vars
#
dat2 %>%
  filter(Variable %in% c("TOTP", "TOTP_P", "PO4-P", "POP") & !is.na(Value)) %>%
  group_by(Year = year(Time), Variable) %>%
  count() %>%
  pivot_wider(names_from = Variable, values_from = n)

```



### Check sums of N variables   
```{r}
check_sums_n1(dat2)
check_sums_n2(dat2)
check_sums_n3(dat2)
```

### N, plot biggest discrepancy   
- Plots all N variables (colors/circles), plus the sum of inorganic N (NH4 + NO3 + NO2) in black  
- Dotted vertical line(s) indicates where the sum is 15% higher than TOTN (example: VT67, 0 m)  
```{r}

nutrient_plot_n("VT66", 0)
nutrient_plot_n("VT67", 0)

```


### Check sums of P variables   
Check whether  
1) TotP is smaller or equal to phosphate + particular P (TOTP_P)   
2) TotP is smaller or equal to phosphate     
In case 1), some are a lot off. This sum is not used by André

```{r}

check_sums_p1(dat2, max_n = 1000)
check_sums_p2(dat2)

```

### P, plot biggest discrepancy   
-170%   

```{r}

nutrient_plot_p("VT3", 10)

```


```{r}

# TOTP vs PO3 + TOTP_P
# TOTP too small in 63 cases (ca 4%)
df <- dat2 %>%
  filter(Variable %in% c("TOTP", "TOTP_P", "PO4-P") & !is.na(Value)) %>%
  select(StationCode, Time, Depth1, Variable, Value) %>%
  pivot_wider(names_from = Variable, values_from = Value) %>%
  mutate(Check = (TOTP - `TOTP_P` - `PO4-P`)/TOTP*100) %>%      # Check = difference in % of TOTN
  filter(!is.na(Check))
cat("======================================================================\n")
cat("Check whether TotP is smaller or equal to inorganic P + TOTP_P\n")
cat("Observations per year:\n")
table(year(df$Time))
if (sum(df$Check < 0)){
  cat("TotP smaller than inorganic P + TOTP_P in", sum(df$Check < 0), "cases (see table)\n\n")
  table(df$Check > 0)
  df[df$Check < 0,] %>% arrange(Check)
} else {
  cat("\nTotP never smaller than inorganic P + TOTP_P\n\n")
}

# ggplot(df, aes(Check)) + geom_histogram()


# TOTP vs PO3
# TOTP too small in 23 cases (ca 4%)
df <- dat2 %>%
  filter(Variable %in% c("TOTP", "PO4-P") & !is.na(Value)) %>%
  select(StationCode, Time, Depth1, Variable, Value) %>%
  pivot_wider(names_from = Variable, values_from = Value) %>%
  mutate(Check = (TOTP - `PO4-P`)/TOTP*100) %>%      # Check = difference in % of TOTN
  filter(!is.na(Check))
cat("======================================================================\n")
cat("Check whether TotP is smaller or equal to inorganic P\n")
cat("Observations per year:\n")
table(year(df$Time))
if (sum(df$Check < 0)){
  cat("TotP smaller than inorganic P in", sum(df$Check < 0), "cases (see table)\n\n")
  table(df$Check > 0)
  df[df$Check < 0,] %>% arrange(Check)
} else {
  cat("\nTotP never smaller than inorganic P \n\n")
}

# For extra check
if (FALSE){
  df[df$Check < 0,] %>%
    filter(year(Time) >= 2017) %>%
    arrange(StationCode, Time)
}

```

## 7. Nutrients, compare values in Excel sheet  

- Compares mean values calculated from raw data with values in the "NIVAKlass" excel sheets  

### Nutrients, get mean values from raw data  
- 
```{r}
# dput(unique(dat2$Variable))

# Total fosfor (μg P/l), vinter
# Fosfat-fosfor (μg P/l), vinter
# Total nitrogen (μg N/l), vinter
# Nitrat-nitrogen (μg N/l), vinter
# Ammonium-nitrogen (μg N/l), vinter

NIVAklass_get_meanvalues <- function(years, data, vars, months, depths = c(0,5,10)){
  data %>%
    filter(Variable %in% vars & 
             Depth1 %in% depth &
             month(Time) %in% months & year(Time) %in% years &
             StationCode %in% order_as_excel) %>% 
    group_by(StationCode, Variable) %>%
    summarize(Value = mean(Value)) %>%
    mutate(Variable = factor(Variable, levels = vars)) %>%
    arrange(Variable)
}

NIVAklass_summervalues <- function(years, data){
  NIVAklass_get_meanvalues(years = years, 
                           data = data, 
                           # Same order as in NIVAklass Excel sheet:
                           vars = c("TOTP", "PO4-P", "TOTN", "NO3+NO2-N", "NH4-N"),
                           months <- c(6,7,8)
                           )
}

NIVAklass_wintervalues <- function(years, data){
  NIVAklass_get_meanvalues(years = years, 
                           data = data, 
                           # Same order as in NIVAklass Excel sheet:
                           vars = c("TOTP", "PO4-P", "TOTN", "NO3+NO2-N", "NH4-N"),
                           months <- c(1,2,12)
                           )
}

NIVAklass_nutrientvalues <- function(years, data){
  df_nut_summer <- NIVAklass_summervalues(years, data) %>%
    mutate(Season = "Summer") %>%
    select(StationCode, Season, Variable, Value)
  df_nut_winter <- NIVAklass_wintervalues(years, data) %>%
    mutate(Season = "Winter") %>%
    select(StationCode, Season, Variable, Value)
  bind_rows(df_nut_summer, df_nut_winter) %>%
    arrange(StationCode, Season, Variable)
 }

df_mean_nutrients <- NIVAklass_nutrientvalues(2017:2019, dat2)

df_mean_nutrients %>%
  filter(StationCode == "VT67" & Season == "Winter")

```

```{r}
NIVAklass_compare_with_excel <- function(stationcode, 
                                         nutrientvalues,
                                         excel_folder,
                                         excel_filename_pattern = "NIVAklass_%s_2019.xlsx",
                                         rows_summer = 98:102,
                                         rows_winter = 106:110){
  fn <- sprintf(excel_filename_pattern, stationcode)
  klass_sheet <- read_excel(paste0(excel_folder, "/", fn), 
                            sheet = "Klassifisering",            # HARD-CODED STUFF
                            range = "B22:D155")                  # HARD-CODED STUFF
  names(klass_sheet)[1] <- "Indicator"
  klass_sheet <- klass_sheet[,c(1,3)]
  # Summer
  result1 <- klass_sheet[98:102,]                                # HARD-CODED STUFF
  result1$Value_from_R <- nutrientvalues %>% 
    filter(StationCode == stationcode & Season == "Summer") %>%
    pull(Value)
  # Winter
  result2 <- klass_sheet[106:110,]                               # HARD-CODED STUFF
  result2$Value_from_R <- nutrientvalues %>% 
    filter(StationCode == stationcode & Season == "Winter") %>%
    pull(Value)
  # Add difference in percent
  bind_rows(result1, result2) %>%
    mutate(Diff_perc = round((Verdi-Value_from_R)/Value_from_R*100, 1))
  }

# Test
nivaklass_folder_2019 <- "K:/Prosjekter/Sjøvann/KYSTOVERVÅKING ØKOKYST/KYSTOVERVÅKING ØKOKYST 2017-2020/ØKOKYST DP Skagerrak O-17089_19089/Årsrapport2019/Årsrapport 2019 data/Vannmassene/NIVAklass"

NIVAklass_compare_with_excel("VT67",
                             df_mean_nutrients,
                             excel_folder = nivaklass_folder_2019)

```


### Check winter values, one file  
```{r}

station <-"VT67"
df_nut_winter %>% filter(StationCode == station)

klass_folder <- "K:/Prosjekter/Sjøvann/KYSTOVERVÅKING ØKOKYST/KYSTOVERVÅKING ØKOKYST 2017-2020/ØKOKYST DP Skagerrak O-17089_19089/Årsrapport2019/Årsrapport 2019 data/Vannmassene/NIVAklass"
fn <- paste0(klass_folder, "/NIVAklass_", station, "_2019.xlsx")
fn <- "NIVAklass_", station, "_2019.xlsx")
klass_sheet <- read_excel(fn, sheet = "Klassifisering", range = "B22:D155")
names(klass_sheet)[1] <- "Indicator"
check <- klass_sheet[106:110,] 
check$Value_from_R <- df_nut_winter %>% 
  filter(StationCode == station) %>% 
  pull(Value)
check <- check %>%
  mutate(Diff_perc = round((Verdi-Value_from_R)/Value_from_R*100, 1))
check

```

### Check one file, function    
```{r}
check
station <-"VT67"
df_nut %>% filter(StationCode == station)

klass_folder <- "K:/Prosjekter/Sjøvann/KYSTOVERVÅKING ØKOKYST/KYSTOVERVÅKING ØKOKYST 2017-2020/ØKOKYST DP Skagerrak O-17089_19089/Årsrapport2019/Årsrapport 2019 data/Vannmassene/NIVAklass"
fn <- paste0(klass_folder, "/NIVAklass_", station, "_2019.xlsx")
klass_sheet <- read_excel(fn, sheet = "Klassifisering", range = "B22:D155")
names(klass_sheet)[1] <- "Indicator"
indicators <- c("Total fosfor (µg P/l), vinter", "Fosfat-fosfor (µg P/l), vinter", 
                "Total nitrogen (µg N/l), vinter", "Nitrat-nitrogen (µg N/l), vinter", 
                "Ammonium-nitrogen (µg N/l), vinter")
check <- klass_sheet[106:110,] 
check$Value_from_R <- df_nut %>% filter(StationCode == station) %>% pull(Value)
check <- check %>%
  mutate(Diff_perc = round((Verdi-Value_from_R)/Value_from_R*100, 1))
check

```



## 11. Read Norskehavet Nord I files  
Used by Caroline     
```{r}
# Based on section 5 above

fn <- "K:/Avdeling/214-Oseanografi/DATABASER/OKOKYST_2017/AqM_download_2019/AqM_2019_NH_Sor1_des2019.xlsx"

dat_broad <- AqMexport_read_waterchemistry(fn, reformat_long = FALSE)   # 30 seconds
dat1 <- AqMexport_reformat_long(dat_broad, remove_duplicates = FALSE)
dat2 <- AqMexport_remove_duplicates(dat1)

xtabs(~StationCode + ProjectId, dat2)

# Skinnbrokleia = VT71!
# delete duplicate data in ProjectID "6342,11946", "6342,6342,11946,11946" 
dat2 <- dat2 %>%
  filter(StationCode != "Skinnbrokleia")   

```

### Checks
```{r}

# Check
xtabs(~Variable, dat2)
xtabs(~Variable + StationCode, dat2)

# Check - note that 0.5 m was used instead of 0 m before 2017  
dat2 %>%
  filter(Variable %in% "NO3+NO2-N") %>%
  xtabs(~Depth1 + year(Time), .)

# Check
# NO3+NO2-N and NH4-N used all years  
# NO2 + NO3 not used
dat2 %>%
  filter(Variable %in% c("TOTN", "NH4-N", "NO3+NO2-N", "NO2-N", "NO3-N", "PON") & !is.na(Value)) %>%
  xtabs(~Variable + year(Time), .)
  

# Check
dat2 %>%
  filter(Variable %in% "NO3+NO2-N" & Depth1 %in% c(0,5,10) & year(Time) == 2017 & month(Time) == 2)

dat2 %>%
  mutate(Depth1 = ifelse(Depth1 == 0.5, 0, Depth1)) %>%
  filter(Variable %in% "NO3+NO2-N" & Depth1 %in% c(0, 30)) %>%
  ggplot(aes(Time, Value, color = factor(Depth1))) +
  geom_line() + geom_point() +
  facet_grid(vars(StationCode), vars(Depth1))
  

```

## 12. Nutrients, check sums
### N, plot biggest discrepancy   
- Plots all N variables (colors/circles), plus the sum of inorganic N (NH4 + NO3 + NO2) in black  
- Dotted vertical line(s) indicates where the sum is 15% higher than TOTN (example: VT67, 0 m)  
```{r}

nutrient_plot_n("VT71", 0)
nutrient_plot_n("VR51", 0)

```




### Check sums of P variables   
Check whether  
1) TotP is smaller or equal to phosphate + particular P (TOTP_P)   
2) TotP is smaller or equal to phosphate     
None are a lot off
```{r}

check_sums_p1(dat2, max_n = 1000)
check_sums_p2(dat2)

```

### P, plot biggest discrepancy   
-170%   

```{r}

nutrient_plot_p("VT71", 0)
nutrient_plot_p("VR51", 0)

```



## 13. Nutrients, compare with values in Excel sheet  
  
- Compares mean values calculated from raw data with values in the "NIVAKlass" excel sheets  
- Also see the sheet 'VT71_stats' in the AqM excel file that we read in section 11  
  
### Nutrients, get mean values from raw data   
- Compare with vallues used in NIVAclass excel sheets here:  
`K:\Prosjekter\Sjøvann\KYSTOVERVÅKING ØKOKYST\KYSTOVERVÅKING ØKOKYST 2017-2020\ØKOKYST DP Norskehavet Sør I O-17091_18091_19091_200091\Rapport 2019-data\klassification`  
- Got close to the numbers used for VT71, but not enough to change class for any of them 
- Got exactly same numbers as those used for VR51  
```{r}
# dput(unique(dat2$Variable))

# Total fosfor (μg P/l), vinter
# Fosfat-fosfor (μg P/l), vinter
# Total nitrogen (μg N/l), vinter
# Nitrat-nitrogen (μg N/l), vinter
# Ammonium-nitrogen (μg N/l), vinter

order_as_excel <- c("VT71", "VR51")

NIVAklass_get_meanvalues <- function(years, data, vars, months, depths = c(0,5,10)){
  data %>%
    mutate(Depth1 = ifelse(Depth1 == 0.5, 0, Depth1)) %>%
    filter(Variable %in% vars & 
             Depth1 %in% depths &
             month(Time) %in% months & year(Time) %in% years &
             StationCode %in% order_as_excel) %>% 
    group_by(StationCode, Variable) %>%
    summarize(Value = mean(Value)) %>%
    mutate(Variable = factor(Variable, levels = vars)) %>%
    arrange(Variable)
}

NIVAklass_summervalues <- function(years, data){
  NIVAklass_get_meanvalues(years = years, 
                           data = data, 
                           # Same order as in NIVAklass Excel sheet:
                           vars = c("TOTP", "PO4-P", "TOTN", "NO3+NO2-N", "NH4-N"),
                           months = c(6,7,8)
                           )
}

NIVAklass_wintervalues <- function(years, data){
  NIVAklass_get_meanvalues(years = years, 
                           data = data, 
                           # Same order as in NIVAklass Excel sheet:
                           vars = c("TOTP", "PO4-P", "TOTN", "NO3+NO2-N", "NH4-N"),
                           months = c(1,2,12)
                           )
}

NIVAklass_nutrientvalues <- function(years, data){
  df_nut_summer <- NIVAklass_summervalues(years, data) %>%
    mutate(Season = "Summer") %>%
    select(StationCode, Season, Variable, Value)
  df_nut_winter <- NIVAklass_wintervalues(years, data) %>%
    mutate(Season = "Winter") %>%
    select(StationCode, Season, Variable, Value)
  bind_rows(df_nut_summer, df_nut_winter) %>%
    arrange(StationCode, Season, Variable)
 }

df_mean_nutrients <- NIVAklass_nutrientvalues(2017:2019, dat2)

df_mean_nutrients %>%
  filter(StationCode == "VT71" & Season == "Summer")

df_mean_nutrients %>%
  filter(StationCode == "VT71" & Season == "Winter")

df_mean_nutrients %>%
  filter(StationCode == "VR51" & Season == "Summer")

df_mean_nutrients %>%
  filter(StationCode == "VR51" & Season == "Winter")

```

## 14. Chl a quantiles    
- Fairly big difference for VR51 - 3.01 used in Excel, got 3.64 here   
- Small difference for VT711 - 1.78 used in Excel, got 1.78 here    
```{r}

NIVAklass_get_chl_data <- function(years, data, months = 2:10, depths = c(0,5,10)){
  data %>%
    mutate(Depth1 = ifelse(Depth1 == 0.5, 0, Depth1)) %>%
    filter(Variable %in% "KlfA" & 
             Depth1 %in% depths &
             month(Time) %in% months & year(Time) %in% years &
             StationCode %in% order_as_excel) %>% 
    select(StationCode, Time, Depth1, Variable, Value) %>%
    pivot_wider(names_from = Depth1, values_from = Value, names_prefix = "Depth")  %>%
    mutate(Max = pmax(Depth0, Depth5, Depth10, na.rm = TRUE))
    }


NIVAklass_plot_chl <- function(chldata){
  chldata %>%
    pivot_longer(c(Depth0, Depth5, Depth10, Max), names_to = "Depth", values_to = "KlfA") %>%
    ggplot(aes(Time, KlfA, color = Depth)) +
    geom_line() +
    facet_wrap(vars(StationCode))
}

NIVAklass_get_chl_quantiles <- function(chldata){
  chldata %>%
    group_by(StationCode) %>%
    summarise_at(c("Depth0", "Depth5", "Depth10", "Max"), 
             quantile, probs = 0.9, na.rm = TRUE, type = 7)  # type = 7 correponds to PERCENTILE:INC in Excel
                                                             # See part 6 above
    }


df <- NIVAklass_get_chl_data(2017:2019, dat2)

df
NIVAklass_plot_chl(df)
NIVAklass_get_chl_quantiles(df)


```


## 15. Bottom O2  
Code from script 13 '13_QA_CTD_2019.Rmd'    
Remember that oxygen should be in ml/L! - See below  
```{r}
### Folders

basefolder <- "K:/Avdeling/214-Oseanografi/DATABASER/OKOKYST_2017/"

# Norskehavet Sør I
folder1 <- "OKOKYST_NH_Sor1_RMS/xlsbase/TilAquamonitor"

#
# Get data frame with one line per data file
#
# 1. Find sheet names here: (can be commented out afterwards)
# sheets_in_folder(folder1)                                 
# 2. Enter the sheet names here:  
fileinfo <- vars_in_folder(folder1, c("data","data","Data"))       

#
# Get data as list
#
datalist <- seq_len(nrow(fileinfo)) %>% map(read_data_fileno, df_fileinfo = fileinfo)

#
# Get data frame with one line per station
# NOTE: Not actally needed
#
fileinfo_stations <- seq_len(nrow(fileinfo)) %>% map_df(get_stations)
fileinfo_stations
```

### Check and combine all data   
Remember that oxygen should be in ml/L!   
```{r}
# Check variable names of each dataset
map(datalist, names)

map(datalist, ~"StationCode" %in% names(.))   # note StationId instead of StationCode in 3rd file!

# Check start of file of each dataset
map(datalist, head)  

# For file no 3, we want Oxygen__1! (oxygen in ml/L)
#   (inspect 2nd row of Excel file)
# So we delete the original Oksygen and make a new one
datalist[[3]] <- datalist[[3]] %>%
  select(-Oksygen) %>%
  rename(Oksygen = Oksygen__1) %>%
  rename(StationCode = StationId)    # Also remember this!

# datalist[[3]] %>% filter(Depth1 == 200.5) %>% View("Data no 3")

# Combine
data_all <- bind_rows(datalist)

# Check
# data_all %>% filter(Depth1 == 200.5) %>% View("Data_all")

```


### VR51  
```{r}
dat <- data_all %>%
  filter(StationCode %in% "VR51")

# Plot data availablity 1 - number of data with/without Oxygen
dat %>%
  count(Date, Has_data = !is.na(Oksygen)) %>%
  ggplot(aes(Date, n, color = Has_data)) + 
  geom_vline(aes(xintercept = Date), color = "grey60") +
  geom_point()

# Plot data availablity 2 - max depth
dat %>%
  filter(!is.na(Oksygen)) %>%
  group_by(Date) %>%
  summarise(Max_depth = max(Depth1)) %>%
  ggplot(aes(Date, Max_depth)) + 
  geom_vline(aes(xintercept = Date), color = "grey60") +
  geom_point()

```

### Get oxygen at max depth    
Mean for last 3 years = 3.844558    
Mean for last 3 years, winer only = 3.641219   
```{r}

dat_bottom <- dat %>%
  filter(!is.na(Oksygen)) %>%
  group_by(Date) %>%
  mutate(Max_depth = max(Depth1)) %>%
  filter(Depth1 == Max_depth & Depth1 > 230) # 230 is from plot above

dat_o2min <- dat %>%
  filter(!is.na(Oksygen)) %>%
  group_by(Date) %>%
  mutate(Min_O2 = min(Oksygen)) %>%
  filter(Oksygen == Min_O2) %>%
  summarise(Oksygen = mean(Oksygen), Depth1 = mean(Depth1))

dat_o2min %>% select(Date, Oksygen, Depth1)
  
dat_oxygen <- bind_rows(
  dat_bottom %>% select(Date, Oksygen, Depth1) %>% mutate(Position = "Bottom"),
  dat_o2min %>% select(Date, Oksygen, Depth1) %>% mutate(Position = "O2-minimum")
)

time_1may = ymd_hms(c(20170501000000, 20180501000000, 20190501000000))
time_1oct = ymd_hms(c(20171001000000, 20181001000000, 20191001000000))

ggplot(dat_bottom, aes(Date, Oksygen)) +
  geom_vline(xintercept = c(time_1may, time_1oct), linetype = "dotted") +
  geom_line() +
  geom_point(aes(color = Depth1)) +
  geom_hline(yintercept = seq(1.5, 4.5, 1), linetype = "dashed", color = "red3")

ggplot(dat_o2min, aes(Date, Oksygen)) +
  geom_vline(xintercept = c(time_1may, time_1oct), linetype = "dotted") +
  geom_line() +
  geom_point(aes(color = Depth1)) +
  geom_hline(yintercept = seq(1.5, 4.5, 1), linetype = "dashed", color = "red3")

ggplot(dat_oxygen, aes(Date, Oksygen, color = Position)) +
  geom_vline(xintercept = c(time_1may, time_1oct), linetype = "dotted") +
  geom_line() +
  geom_point() +
  geom_hline(yintercept = seq(1.5, 4.5, 1), linetype = "dashed", color = "red3")


# Mean oxygen for all months
dat_oxygen %>%
  group_by(Position) %>%
  summarise(Oksygen = mean(Oksygen))

# Mean oxygen for winter (Sept - April)
dat_oxygen %>%
  filter(month(Date) <= 4 | month(Date) >= 9) %>%
  group_by(Position) %>%
  summarise(Oksygen = mean(Oksygen))

```


### VT71
```{r}

```



